<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Ternary Survey — Today vs 2075</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    :root{--ring:#e5e7eb;--bg:#f8fafc;--muted:#6b7280}
    *{box-sizing:border-box} body{margin:0;background:linear-gradient(#fff,var(--bg));font:15px/1.5 system-ui,Segoe UI,Inter,Arial}
    .wrap{max-width:960px;margin:0 auto;padding:24px}
    h1{margin:0 0 6px;font-size:22px} .muted{color:var(--muted)}
    .card{background:#fff;border:1px solid var(--ring);border-radius:14px;box-shadow:0 2px 8px rgba(0,0,0,.03);margin-top:14px}
    .body{padding:16px}
    .row{display:grid;gap:14px} .row.cols-2{grid-template-columns:1fr 1fr}
    .row.cols-3{grid-template-columns:repeat(3,1fr)}
    .bar{display:flex;gap:8px;flex-wrap:wrap}
    .btn{border:1px solid var(--ring);background:#fff;border-radius:999px;padding:9px 14px;font-weight:600;cursor:pointer}
    .btn.primary{background:#111827;color:#fff;border-color:#111827}
    .btn.active{outline:2px solid #11182710}
    input[type="text"],input[type="url"],input[type="number"]{width:100%;padding:10px 12px;border:1px solid var(--ring);border-radius:10px}
    #plot{width:100%;height:460px}
    .help{font-size:12px;color:var(--muted)}
    label{font-weight:600}
  </style>
</head>
<body>
  <div class="wrap">
    <header style="display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;align-items:flex-start">
      <div>
        <h1>Ternary Survey: Today vs 2075</h1>
        <div class="muted">
          Place dots for <b>Today</b> and <b>2075</b> across
          <b>Economic Prosperity</b>, <b>Social Equity</b>, and <b>Individual Autonomy</b>. A + B + C = 100%.
        </div>
      </div>
      <div class="bar" role="group" aria-label="Active point">
        <button id="btnToday" class="btn active">Set with clicks: Today</button>
        <button id="btnFuture" class="btn">2075</button>
      </div>
    </header>

    <div class="card"><div class="body">
      <div id="plot" aria-label="Ternary plot"></div>
      <div class="help">Click inside the triangle to place the selected point (Today or 2075). Click again to move it.</div>
    </div></div>

    <!-- Numeric inputs for Today -->
    <div class="card"><div class="body">
      <h3>Today — enter percentages (A + B + C = 100)</h3>
      <div class="row cols-3">
        <div>
          <label>Economic Prosperity (A)</label>
          <input id="todayA_num" type="number" min="0" max="100" step="0.25">
        </div>
        <div>
          <label>Social Equity (B)</label>
          <input id="todayB_num" type="number" min="0" max="100" step="0.25">
        </div>
        <div>
          <label>Individual Autonomy (C)</label>
          <input id="todayC_num" type="number" min="0" max="100" step="0.25">
        </div>
      </div>
    </div></div>

    <!-- Numeric inputs for 2075 -->
    <div class="card"><div class="body">
      <h3>2075 — enter percentages (A + B + C = 100)</h3>
      <div class="row cols-3">
        <div>
          <label>Economic Prosperity (A)</label>
          <input id="futureA_num" type="number" min="0" max="100" step="0.25">
        </div>
        <div>
          <label>Social Equity (B)</label>
          <input id="futureB_num" type="number" min="0" max="100" step="0.25">
        </div>
        <div>
          <label>Individual Autonomy (C)</label>
          <input id="futureC_num" type="number" min="0" max="100" step="0.25">
        </div>
      </div>
    </div></div>

    <div class="card"><div class="body">
      <h3>Save & Submit</h3>
      <div class="row cols-2">
        <div>
          <label>Respondent ID (optional)</label>
          <input id="respId" type="text" placeholder="e.g., anon-001">
        </div>
        <div>
          <label>Webhook URL</label>
          <input id="webhook" type="url"
            value="https://script.google.com/macros/s/AKfycbw3xaSY3Q6pGo66hiTKOFtxImpolPMt04u30I1gQ8zUqDuxXCtbVCRFn7LJQEmzx5-v/exec"
            readonly>
          <div class="help">This is pre-connected to your Google Sheet. You don’t need to paste it again.</div>
        </div>
      </div>
      <div class="bar" style="margin-top:10px">
        <button id="btnSubmit" class="btn primary">Submit response</button>
        <button id="btnDownload" class="btn">Download CSV (local)</button>
        <button id="btnReset" class="btn">Reset points</button>
        <span id="status" class="help" aria-live="polite"></span>
      </div>
    </div></div>

    <p class="help">Axes: A = Economic Prosperity, B = Social Equity, C = Individual Autonomy.</p>
  </div>

  <script>
    // ---------------- State ----------------
    const A_LABEL = "Economic Prosperity";
    const B_LABEL = "Social Equity";
    const C_LABEL = "Individual Autonomy";

    let active = "today";
    let today  = { a:33.33, b:33.33, c:33.34 };
    let future = { a:33.33, b:33.33, c:33.34 };
    let responses = [];

    const round2 = x => Math.round((x + Number.EPSILON) * 100) / 100;
    const clamp  = x => Math.max(0, Math.min(100, Number.isFinite(x) ? x : 0));

    function setFromAB(target, a, b){
      const aa = clamp(a);
      const bb = clamp(Math.min(b, 100 - aa));
      target.a = round2(aa);
      target.b = round2(bb);
      target.c = round2(100 - target.a - target.b);
    }

    function applyABCChange(target, changedKey, newVal){
      let a = target.a, b = target.b, c = target.c;
      if (changedKey === "a") {
        a = clamp(newVal); b = clamp(Math.min(b, 100 - a)); c = round2(100 - a - b);
      } else if (changedKey === "b") {
        b = clamp(newVal); a = clamp(Math.min(a, 100 - b)); c = round2(100 - a - b);
      } else if (changedKey === "c") {
        c = clamp(newVal); a = clamp(a); b = round2(100 - a - c); if (b < 0){b=0; c=round2(100-a);}
      }
      target.a = round2(a); target.b = round2(b); target.c = round2(c);
    }

    const layout = {
      margin:{l:20,r:20,t:20,b:20},
      ternary:{sum:100,aaxis:{title:A_LABEL,min:0,ticksuffix:"%"},baxis:{title:B_LABEL,min:0,ticksuffix:"%"},caxis:{title:C_LABEL,min:0,ticksuffix:"%"},bgcolor:"rgba(0,0,0,0)"},
      legend:{orientation:"h",x:0.5,xanchor:"center",y:-0.1},
      paper_bgcolor:"rgba(0,0,0,0)",showlegend:true
    };

    function traces(){
      return [
        {type:"scatterternary",mode:"markers",a:[today.a],b:[today.b],c:[today.c],name:"Today",marker:{size:12,symbol:"circle"}},
        {type:"scatterternary",mode:"markers",a:[future.a],b:[future.b],c:[future.c],name:"2075",marker:{size:12,symbol:"diamond"}},
        {type:"scatterternary",mode:"lines",a:[today.a,future.a],b:[today.b,future.b],c:[today.c,future.c],name:"Change",hoverinfo:"skip",line:{width:2}}
      ];
    }

    function draw(){Plotly.react("plot",traces(),layout,{responsive:true});syncInputs();}

    function onPlotClick(evt){
      const p = evt?.points?.[0]; if(!p) return;
      const a=round2(p.a??0), b=round2(p.b??0);
      if(active==="today") setFromAB(today,a,b); else setFromAB(future,a,b);
      draw();
    }

    function syncInputs(){
      document.getElementById("todayA_num").value=today.a;
      document.getElementById("todayB_num").value=today.b;
      document.getElementById("todayC_num").value=today.c;
      document.getElementById("futureA_num").value=future.a;
      document.getElementById("futureB_num").value=future.b;
      document.getElementById("futureC_num").value=future.c;
    }

    function wireABC(prefix, point){
      ["A","B","C"].forEach(k=>{
        const el=document.getElementById(prefix+k+"_num");
        el.addEventListener("input",()=>{const v=parseFloat(el.value);if(Number.isFinite(v)){applyABCChange(point,k.toLowerCase(),v);draw();}});
      });
    }

    function toCSV(rows){
      const h=["response_id","timestamp_iso","today_a","today_b","today_c","future_a","future_b","future_c"];
      const lines=[h.join(",")];
      rows.forEach(r=>lines.push([r.id,r.ts,r.today.a,r.today.b,r.today.c,r.future.a,r.future.b,r.future.c].join(",")));
      return lines.join("\n");
    }

    function downloadCSV(){
      const blob=new Blob([toCSV(responses)],{type:"text/csv"});const url=URL.createObjectURL(blob);
      const a=document.createElement("a");a.href=url;a.download="responses.csv";a.click();URL.revokeObjectURL(url);
    }

    async function submit(){
      const id=document.getElementById("respId").value||crypto.randomUUID();
      const record={id,ts:new Date().toISOString(),today:{...today},future:{...future}};responses.push(record);
      const status=document.getElementById("status");status.textContent="Saved locally";
      const url=document.getElementById("webhook").value.trim();
      if(url){try{await fetch(url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(record),mode:"no-cors"});status.textContent="Submitted to webhook";}catch(e){status.textContent="Submit failed";}}
    }

    function resetPoints(){today={a:33.33,b:33.33,c:33.34};future={a:33.33,b:33.33,c:33.34};draw();}

    function init(){
      draw();
      document.getElementById("plot").on("plotly_click",onPlotClick);
      document.getElementById("btnToday").onclick=()=>{active="today";btnToday.classList.add("active");btnFuture.classList.remove("active");};
      document.getElementById("btnFuture").onclick=()=>{active="future";btnFuture.classList.add("active");btnToday.classList.remove("active");};
      document.getElementById("btnSubmit").onclick=submit;
      document.getElementById("btnDownload").onclick=downloadCSV;
      document.getElementById("btnReset").onclick=resetPoints;
      wireABC("today",today);wireABC("future",future);
    }
    document.addEventListener("DOMContentLoaded",init);
  </script>
</body>
</html>
